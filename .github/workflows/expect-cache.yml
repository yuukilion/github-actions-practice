name: Expect Command Cache Example

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # æ‰‹å‹•å®Ÿè¡Œã®ãŸã‚ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’è¿½åŠ 
  workflow_dispatch:

jobs:
  test-expect-cache:
    runs-on: ubuntu-latest
    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - uses: actions/checkout@v4

      # ã‚¹ãƒ†ãƒƒãƒ—2: expectã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç¢ºèª
      - name: Cache Expect Installation
        id: cache-expect
        uses: actions/cache@v4
        with:
          path: /usr/bin/expect
          key: ${{ runner.os }}-expect-${{ hashFiles('/usr/bin/expect') }}
      
      # ã‚¹ãƒ†ãƒƒãƒ—3: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
      - name: Check Cache Status
        run: |
          if [ "${{ steps.cache-expect.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãƒ’ãƒƒãƒˆã—ã¾ã—ãŸã€‚expectã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          else
            echo "âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ã§ã™ã€‚expectã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚"
          fi

      # ã‚¹ãƒ†ãƒƒãƒ—4: expectã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ã®å ´åˆã®ã¿ï¼‰
      - name: Install Expect
        if: steps.cache-expect.outputs.cache-hit != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y expect
          echo "ğŸ“¦ expectã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ"

      # ã‚¹ãƒ†ãƒƒãƒ—5: expectã‚³ãƒãƒ³ãƒ‰ã®å‹•ä½œç¢ºèª
      - name: Verify Expect Installation
        run: |
          which expect
          expect -version
          echo "ğŸ” expectã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚"

      # ã‚¹ãƒ†ãƒƒãƒ—6: ã‚·ãƒ³ãƒ—ãƒ«ãªexpectã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
      - name: Run Simple Expect Script
        run: |
          cat << 'EOF' > test.exp
          #!/usr/bin/expect -f
          spawn echo "Hello from expect!"
          expect "Hello"
          send_user "\nExpect script completed successfully!\n"
          exit 0
          EOF
          chmod +x test.exp
          ./test.exp