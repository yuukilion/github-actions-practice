name: Expect Command Cache Example

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # æ‰‹å‹•å®Ÿè¡Œã®ãŸã‚ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’è¿½åŠ 
  workflow_dispatch:

jobs:
  test-expect-cache:
    runs-on: ubuntu-latest
    steps:
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - uses: actions/checkout@v5.0.1

      # ã‚¹ãƒ†ãƒƒãƒ—2: APTã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è¨­å®š
      - name: Cache APT Packages
        id: cache-apt
        uses: actions/cache@v4.3.0
        with:
          path: ${{ github.workspace }}/.apt-cache
          key: ${{ runner.os }}-apt-expect

      # ã‚¹ãƒ†ãƒƒãƒ—3: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
      - name: Check Cache Status
        run: |
          if [ "${{ steps.cache-apt.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… APTã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãƒ’ãƒƒãƒˆã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒé«˜é€ŸåŒ–ã•ã‚Œã¾ã™ã€‚"
          else
            echo "âŒ APTã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ã§ã™ã€‚é€šå¸¸é€Ÿåº¦ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚"
          fi

      # ã‚¹ãƒ†ãƒƒãƒ—4: expectã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰ç„¡ã«ã‹ã‹ã‚ã‚‰ãšå¿…è¦ï¼‰
      - name: Install Expect
        run: |
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€APTè¨­å®šã‚’è¿½åŠ 
          mkdir -p ${{ github.workspace }}/.apt-cache/partial
          chmod -R 777 ${{ github.workspace }}/.apt-cache
          echo 'Dir::Cache::Archives "${{ github.workspace }}/.apt-cache";' | sudo tee /etc/apt/apt.conf.d/01custom
          
          # APTã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆã€apt-get updateã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã‚‹
          if [ "${{ steps.cache-apt.outputs.cache-hit }}" != "true" ]; then
            echo "APTãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¦ã„ã¾ã™..."
            sudo apt-get update
          fi
          
          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²
          start_time=$(date +%s)
          
          # expectã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo apt-get install -y expect
          
          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†æ™‚é–“ã¨æ‰€è¦æ™‚é–“ã‚’è¨ˆç®—
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "ğŸ“¦ expectã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ (æ‰€è¦æ™‚é–“: ${duration}ç§’)"

      # ã‚¹ãƒ†ãƒƒãƒ—5: expectã‚³ãƒãƒ³ãƒ‰ã®å‹•ä½œç¢ºèª
      - name: Verify Expect Installation
        run: |
          which expect
          expect -version
          echo "ğŸ” expectã‚³ãƒãƒ³ãƒ‰ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚"

      # ã‚¹ãƒ†ãƒƒãƒ—6: ã‚·ãƒ³ãƒ—ãƒ«ãªexpectã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
      - name: Run Simple Expect Script
        run: |
          cat << 'EOF' > test.exp
          #!/usr/bin/expect -f
          spawn echo "Hello from expect!"
          expect "Hello"
          send_user "\nExpect script completed successfully!\n"
          exit 0
          EOF
          chmod +x test.exp
          ./test.exp
          
      # ã‚¹ãƒ†ãƒƒãƒ—7: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜å‰ã«æ¨©é™ã‚’ä¿®æ­£
      - name: Cleanup Cache Permissions
        if: always()  # ä»–ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ã¦ã‚‚å¸¸ã«å®Ÿè¡Œ
        run: |
          echo "ğŸ§¹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ã‚’ä¿®æ­£ã—ã¦ã„ã¾ã™..."
          # lockãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          sudo rm -f ${{ github.workspace }}/.apt-cache/lock
          # partialãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿®æ­£
          sudo chmod -R 755 ${{ github.workspace }}/.apt-cache
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ‰€æœ‰è€…ã‚’ãƒ©ãƒ³ãƒŠãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´
          sudo chown -R $(id -u):$(id -g) ${{ github.workspace }}/.apt-cache
          echo "âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"